#
# Long unique bugs related to master slave replication
#

#
# MDEV-22722 Assertion "inited==NONE" failed in handler::ha_index_init on the slave during UPDATE
#

--source include/have_binlog_format_row.inc
--source include/master-slave.inc

create table t1 (i1 int, a1 text, unique key i1 (a1)) engine=myisam;
insert into t1 values (1,1);
insert into t1 values (2,2);
update t1 set a1 = 'd' limit 1;
update t1 set a1 = 'd2' where i1= 2;

sync_slave_with_master;
connection slave;
select * from t1;
connection master;
drop table t1;

sync_slave_with_master;
connection master;

--echo # Idempotent scenario, which triggers REPLACE code to be used in the
--echo # event, i.e. duplicated record will be deleted and then re-inserted.
create table t1 (i1 int, a1 text, unique key i1 (a1)) engine=myisam;

sync_slave_with_master;
connection slave;
set @save_slave_exec_mode= @@slave_exec_mode;
set global slave_exec_mode = idempotent;
insert into t1 values (1,1);
connection master;
insert into t1 values (2,1);
sync_slave_with_master;
connection slave;
select * from t1;
connection master;
insert into t1 values (3,3);
update t1 set a1 = 'd' limit 1;
update t1 set a1 = 'd2' where i1= 3;
sync_slave_with_master;

connection slave;
select * from t1;
set global slave_exec_mode = @save_slave_exec_mode;
connection master;
drop table t1;
--source include/rpl_end.inc
